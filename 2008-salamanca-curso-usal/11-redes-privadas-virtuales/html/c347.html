<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Acceso remoto seguro</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="GNU/Linux, software libre para la comunidad universitaria"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Servidor Jabber"
HREF="x314.html"><LINK
REL="NEXT"
TITLE="Redes Privadas Virtuales (VPN)"
HREF="c380.html"></HEAD
><BODY
CLASS="chapter"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>GNU/Linux, software libre para la comunidad universitaria: Redes privadas virtuales en GNU/Linux</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="x314.html"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="c380.html"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="chapter"
><H1
><A
NAME="AEN347"
></A
>CapÌtulo 5. Acceso remoto seguro</H1
><DIV
CLASS="sect1"
><H1
CLASS="sect1"
><A
NAME="AEN349"
>5.1. Distintas soluciones de acceso remoto</A
></H1
><P
>Para conectarse desde casa o desde otra ubicaci√≥n a la red del trabajo, hay distintas alternativas:</P
><P
></P
><OL
TYPE="1"
><LI
><P
>Usar una VPN, de modo que nuestro ordenador de casa virtualmente est√© en la red de la empresa, pero a trav√©s de una conexi√≥n cifrada v√≠a Internet. Esta es la opci√≥n m√°s potente, pero tambi√©n la m√°s compleja. Una empresa que tenga una pol√≠tica estricta de seguridad sobre las m√°quinas instaladas en la red, con el filtrado de red, se encontrar√° con que cada vez que se conecte el usuario se a√±ade a su red local un nodo que puede estar en una red insegura (aunque esto depende tambi√©n de la configuraci√≥n, un equipo puede conectarse a la red remota y desconectarse del resto). Es una opci√≥n especialmente interesante cuando el usuario usa un port√°til tanto cuanto est√° en la empresa como en su casa.</P
></LI
><LI
><P
>Conectarnos remotamente a nuestro escritorio del PC del trabajo, usando un t√∫nel con SSH (tambi√©n se puede hacer con SSL), con lo que s√≥lo habr√≠a que abrir un puerto en el cortafuegos de la empresa. Es una soluci√≥n m√°s conservadora, pues virtualmente el usuario est√° usando su monitor, teclado y rat√≥n para acceder a la m√°quina del trabajo, pero por ejemplo no puede ni transferir ficheros entre su equipo local y el de la oficina (aunque algunas soluciones de escritorio remoto s√≠ lo permiten) o conectarse desde su equipo de casa a ning√∫n servicio. Para el usuario tambi√©n es una soluci√≥n sencilla, pues est√° usando su equipo de la oficina en el que ya est√° todo el software instalado y configurado. Sin embargo no es una soluci√≥n id√≥nea si por ejemplo el usuario tiene que escribir un documento y luego enviarlo: para eso ser√≠a m√°s razonable que lo pueda editar en su equipo y conectarse a la intranet de la empresa. Adem√°s esta posibilidad no est√° disponible cuando el trabajador que se conecta remotamente no tiene un PC de sobremesa en la oficina sino que usa un port√°til que se lleva a casa. </P
><P
>T√©cnicamente usando SSH se pueden abrir m√°s t√∫neles para por ejemplo acceder a la web interna o transferir ficheros, pero eso ya supone mayor conocimiento por parte de los usuarios y es as√≠ mismo posible limitar estas posibilidades. De todos modos en el momento que se permite al usuario crear un t√∫nel cifrado potencialmente se le est√° dando acceso total a la red local de la empresa, pues el usuario puede utilizar el t√∫nel para encapsular lo que quiera, incluyendo por ejemplo una sesi√≥n PPP para implementar as√≠ una VPN completa.</P
></LI
><LI
><P
>Usar lo que se ha dado en llamar, no con demasiada propiedad, SSL VPN. Es el caso del programa SSLExplorer Community Edition. Este tipo de soluci√≥n es intermedia entre las dos anteriores. Ofrece una interfaz web, que completada con c√≥digo Java permite navegar por el disco duro de la m√°quina remota, transferir ficheros entre las dos m√°quinas, navegar por la intranet de la empresa... Se implementa tambi√©n con un t√∫nel SSL y permite crear t√∫neles para distintas aplicaciones y lanzar la aplicaci√≥n en cuesti√≥n, por ejemplo rdesktop para conectarse a un escritorio remoto de Windows.</P
><P
>Un detalle de nomenclatura, es que OpenVPN se define tambi√©n como una SSL VPN pero no tiene nada que ver con esto, puesto que es una VPN real, que permite todo lo que ofrece cualquier otra VPN, mientras que las aplicaciones como SSLExplorer no son realmente VPNs. Se define como SSL VPN porque la VPN se encapsula en un t√∫nel SSL y s√≥lo hay que abrir un puerto.</P
></LI
></OL
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="AEN361"
>5.1.1. Una soluci√≥n pr√°ctica: crear un t√∫nel con openSSH<A
NAME="AEN363"
HREF="#FTN.AEN363"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
></A
></H2
><P
>Supongamos que queremos conectarnos desde casa con el puerto 8080 en la m√°quina 192.168.1.100 de la red local de nuestra empresa. Para ello contamos con una m√°quina SSH que est√° dentro de la red local de la empresa y a la que llegamos a trav√©s de un DNAT que hemos hecho en el cortafuegos. En este caso hemos abierto el puerto 34321 del cortafuegos, que tiene la IP p√∫blica 87.15.10.120: los paquetes con este destino cambiar√°n de 87.15.10.120 a 192.168.1.1:22. As√≠ pues, cuando nos conectemos v√≠a ssh a 87.15.10.120:34321, llegamos en realidad al puerto SSH de 192.168.1.1.</P
><P
>La soluci√≥n est√° en utilizar la posibilidad que ofrece SSH de crear t√∫neles. SSH es un protocolo que no s√≥lo cifra y garantiza la integridad de los datos, sino que es capaz de encapsular cuantas conexiones necesitemos en una sola. As√≠, nuestro prop√≥sito es que SSH cree un servidor local en nuestra m√°quina, por ejemplo con el puerto 8081, recoga todo lo que escribamos en √©l, lo env√≠e cifrado hasta la m√°quina 192.168.1.1 (la m√°quina remota a la que nos hemos conectado v√≠a SSH) y desde all√≠ los descifre y los env√≠e al puerto 8080 de la m√°quina 192.168.1.100; los paquetes de respuesta seguir√°n el proceso inverso, hasta llegar al puerto 8081 local de nuestra m√°quina. Observes√© que en el caso del t√∫nel los paquetes pasan por la capa de aplicaci√≥n, mientras que en el NAT simplemente se modifican las cabeceras a nivel IP y TCP para hacer el NAT. La m√°quina 192.168.1.100 no ver√° como IP origen de los paquetes a la IP de nuestra casa, sino a 192.168.1.1, la m√°quina SSH que ha retransmitido el paquete.</P
><P
>En la pr√°ctica, hacer el t√∫nel es tan sencillo como:
<KBD
CLASS="userinput"
>ssh -N 801020.13 -p 34231 -o ServerAliveInterval 1200 -L8081:192.168.1.100:8080</KBD
></P
><P
>La opci√≥n -N es para crear el t√∫nel pero no iniciar una shell. La opci√≥n ServerAliveInterval es para enviar cada 2 minutos un paquete en caso de que la conexi√≥n est√© inactiva, para evitar que el cortafuegos asuma que la conexi√≥n est√© muerta y olvide la asociaci√≥n NAT. Es posible a√±adir m√°s opciones interesantes. Por ejemplo por defecto el puerto 8081 que ha creado ssh es s√≥lo accesible dentro de nuestra m√°quina, si quisi√©ramos que pudieran conectarse a √©l otras m√°quinas de nuestra red local, a√±adiremos la opci√≥n -g.</P
><P
>Es posible tambi√©n crear t√∫neles en los que el puerto servidor se abre en la IP a la que nos conectamos remotamente (en este caso 192.168.1.1) y que se enviara a una IP y puerto de nuestra red local. Esto nos permite crear servidores en la red local de nuestra empresa (para que el puerto sea accesible desde todas las Ips de la red local de la empresa y no s√≥lo desde 192.168.1.1, habr√° que usar la opci√≥n -g).</P
><P
>As√≠, si queremos crear el puerto 8087 en 192.168.1.1 y que todo lo que se reciba all√≠ vaya al puerto 9000 de la IP 192.168.7.3 (en nuestra red local de casa) usar√≠amos:
<KBD
CLASS="userinput"
>ssh -N 801020.13 -p 34231 -o ServerAliveInterval 1200 -g -R192.168.1.1:8087:192.168.7.3:9000</KBD
></P
><P
>Como puede verse, los t√∫neles SSH son muy potentes y un tanto inquietantes desde el punto de vista de la seguridad para un administrador: podemos hacer un t√∫nel para usar el escritorio remoto, para conectarnos a la web de la empresa, para enviar correos desde casa utilizando el servidor SMTP de la empresa, e incluso para ejecutar una aplicaci√≥n en local que usa una BB.DD. de la red, cambiando la configuraci√≥n para que use un puerto en nuestra m√°quina local y usando un t√∫nel. Es m√°s, es posible crear toda una VPN como veremos m√°s adelante, con s√≥lo la posibilidad de crear t√∫neles de SSH.</P
><P
>Por este motivo el administrador de SSH puede desactivar el uso de t√∫neles o especificar exactamente qu√© t√∫neles se pueden usar, as√≠ como permitir o denegar obtener una shell o permitir ejecutar s√≥lo un comando en concreto. Puede as√≠ mismo no permitir el acceso al sistema no d√°ndole una contrase√±a y autenticando por clave p√∫blica: el propio fichero de clave p√∫blica almacenado en el servidor tendr√° las restricciones que se aplican cuando se accede con esa clave, pudi√©ndose tener distintas claves para un mismo usuario seg√∫n se le permita ejecutar una tarea u otra. El administrador tambi√©n puede limitar lo que hagan los usuarios en el fichero de configuraci√≥n global sshd_config mediantve la directiva Match, por usuario, grupo, direcci√≥n o host de origen.</P
><P
>La funcionalidad de SSH no acaba aqu√≠. Es posible que un usuario se conecte a una m√°quina y desde ah√≠ a otras. Si utiliza claves p√∫blicas para autenticarse, SSH incorpora un sistema, el ssh-agent, que permite autenticar al usuario estando conectado en otra m√°quina y sin que nuestra clave privada salga de nuestra m√°quina. Esta funcionalidad tambi√©n es necesaria si se usa una tarjeta criptogr√°fica, pues la clave privada no puede extraerse de la tarjeta ni siquiera por su propietario.</P
><P
>Para usuarios con Windows, en lugar de utilizar el cliente en l√≠nea de comandos pueden recurrir a Putty, un programa con interfaz de usuario basada en ventanas y que en realidad tambi√©n se puede ejecutar en GNU/Linux.</P
><P
>Un peque√±o detalle con SSH: el lanzar programas para ejecutar en modo batch (segundo plano) y que ssh retorne inmediatamente, sin esperar a que el programa lanzado termine. Si se abre una sesi√≥n y se lanzan con nohup funciona, pero si se invoca directamente con ssh un programa no; el cliente de ssh se queda esperando hasta que el programa acabe. El motivo por el que espera es porque la entrada/salida est√° redirigida a sockets y hasta que ssh no detecta que esos sockets est√°n cerrados, no retorna. En la shell interactiva esto no pasa, porque al ejecutar nohup, aparte de no considerarse la se√±al HUP al morir la shell, que es algo que a SSH ni le va ni le importa (y que se puede hacer en cualquier momento aunque el programa no se lanzara con nohup, mediante el comando interno de la shell disown), ocurre que salida est√°ndar y de error se redirige al fichero nohup.out y la entrada est√°ndar a /dev/null, cerr√°ndose la que hasta ahora era E/S est√°ndar y de error, por lo que ssh ya no tiene que esperar. ¬øPero por qu√© la diferencia de comportamiento? La diferencia est√° en que en con una sesi√≥n interactiva se usa un ptty (un terminal virtual) mientras que con un comando aislado no, se usan los sockets directamente y nohup s√≥lo hace la redirecci√≥n si la E/S est√° asociada a un terminal, pues esa es su funci√≥n, que el programa no utilice un terminal que ya no est√° disponible, mientras que sin son ficheros se supone que aunque muera la shell los ficheros siguen existiendo.</P
><P
>La soluci√≥n por lo tanto est√° o bien en manualmente redigir la E/S est√°ndar y de error a nohup.out o /dev/null, o invocar con la opci√≥n -t para que se cree un TTY virtual.</P
></DIV
></DIV
></DIV
><H3
CLASS="FOOTNOTES"
>Notas</H3
><TABLE
BORDER="0"
CLASS="FOOTNOTES"
WIDTH="100%"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN363"
HREF="c347.html#AEN363"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>Openssh no es la √∫nica implementaci√≥n libre de SSH. A destacar dropbear (<A
HREF="http://matt.ucc.asn.au/dropbear/"
TARGET="_top"
>http://matt.ucc.asn.au/dropbear/</A
>), usado sobre todo en sistemas empotrados como PDAs, tel√©fonos, routers por ser mucho m√°s ligero que openssh... La mayor√≠a de lo expuesto en este manual sobre openssh funciona igualmente en dropbear.</P
></TD
></TR
></TABLE
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="x314.html"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Inicio</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="c380.html"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Servidor Jabber</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Redes Privadas Virtuales (VPN)</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>