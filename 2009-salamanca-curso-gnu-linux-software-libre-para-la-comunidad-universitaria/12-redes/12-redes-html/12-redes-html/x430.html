<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>IPsec</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="GNU/Linux, software libre para la comunidad universitaria"
HREF="index.html"><LINK
REL="UP"
TITLE="Redes Privadas Virtuales (VPN)"
HREF="c395.html"><LINK
REL="PREVIOUS"
TITLE="Redes Privadas Virtuales (VPN)"
HREF="c395.html"><LINK
REL="NEXT"
TITLE="SSH + PPPD / SSH + TUN"
HREF="x461.html"></HEAD
><BODY
CLASS="sect1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>GNU/Linux, software libre para la comunidad universitaria: Redes privadas virtuales en GNU/Linux</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="c395.html"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Cap狎ulo 6. Redes Privadas Virtuales (VPN)</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="x461.html"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="sect1"
><H1
CLASS="sect1"
><A
NAME="AEN430"
>6.2. IPsec</A
></H1
><P
>Hay implementaciones de IPsec para cualquier sistema Unix, MacOS X, Windows XP/2000... Una implementaci칩n de IPsec consta de dos partes: la implementaci칩n sobre la pila de protocolos TCP/IP, en el k칠rnel y el demonio y herramientas que se ejecutan en el espacio de usuario para establecer las claves<A
NAME="AEN433"
HREF="#FTN.AEN433"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
> (esto es la parte IKE: Internet Key Exchange<A
NAME="AEN435"
HREF="#FTN.AEN435"
><SPAN
CLASS="footnote"
>[2]</SPAN
></A
>). En principio es posible utilizar la parte IKE de una implementaci칩n sobre la pila de protocolos de otra. As칤, la implementaci칩n integrada en el kernel Linux (llamada NETKEY) no incluye herramientas IKE, por lo que hay que usar las de otra implementaci칩n: habitualmente se usa la implementaci칩n del proyecto Kame (surgido de un consorcio de empresas japonesas como Fujitsu y Toshiba para hacer una implementacion de Ipv6 e IPsec), que es la implementaci칩n usada en Free/NetBSD y en MacOS X; el demonio IKE de Kame se llama Racoon y el conjunto de utilidades portadas para Linux que adem치s de Racoon incluye otras como setkey es IPsec-tools (http://IPsec-tools.sf.net); en Ubuntu Dapper existen por separado los paquetes IPsec-tools y Racoon (s칩lo necesitamos el demonio si la asociaci칩n de seguridad se negocia v칤a IKE (puerto UDP 500) entre las dos partes, no lo necesitamos si la SA se establece manualmente manipulando la SAD con setkey.</P
><P
>Setkey puede ser necesaria aunque se use IKE, para establecer la pol칤tica (la SP), pues esta herramienta es tanto para manipular la SAD como la SPD (basa de datos de asociaciones de seguridad y pol칤ticas de seguridad, respectivamente). Las reglas de las pol칤ticas recuerdan las de iptables: establece que por ejemplo para comunicaciones entre dos rangos de IP, usando determinados protocolos, debe usarse un t칰nel con esp. Sin embargo la pol칤tica se puede crear directamente sin necesidad de setkey desde un programa a nivel de conexi칩n, mediante setsockopt y libipsec (llamada ipsec_set_policy), librer칤a incluida en el paquete racoon pero que por supuesto s칩lo es v치lida para esta implementaci칩n: no est치 estandarizada la sintaxis de las pol칤ticas. </P
><P
>Tambi칠n se puede usar por ejemplo como demonio IKE isakmpd (de la implementaci칩n de OpenBSD) o Pluto. Pluto es el demonio IKE de la antigua implementaci칩n de IPsec para Linux, FreeSWAN, que nunca lleg칩 a formar parte del kernel; FreeSWAN dej칩 de desarrollarse pero tomaron el relevo dos proyectos: OpenSWAN (<A
HREF="http://www.openswan.org"
TARGET="_top"
>www.openswan.org</A
>) y StrongSWAN (<A
HREF="http://www.strongswan.org"
TARGET="_top"
>www.strongswan.org</A
>). Mientras que OpenSWAN sigue desarrollando la pila de protocolos KLIPS como alternativa a la integrada en el kernel, NETKEY(pero su parte IKE funciona tanto con KLIPS como con NETKEY), en StrongSWAN ya s칩lo soportan NETKEY. StrongSWAN es compatible no s칩lo con IKE1 sino con IKE2<A
NAME="AEN441"
HREF="#FTN.AEN441"
><SPAN
CLASS="footnote"
>[3]</SPAN
></A
>: de la compatibilidad con IKE1 se encarga el viejo demonio Pluto, mientras que para IKE2 hay un nuevo demonio llamado Charon. La flexibilidad de programas como StrongSWAN o OpenSWAN son inmensas: incluyendo toda una infraestructura de clave p칰blica basada en certificados X.509, con la posibilidad de utilizar dispositivos como smartcards y teniendo en cuenta aspectos como que los certificados pueden revocarse y ya no ser v치lidos, que pueden obtenerse de servidores LDAP... Otra caracter칤stica interesante es "oportunistic encryption", que se basa en situar los certificados en servidores DNS. Ahora bien, para que esto sea seguro, hay que usar DNSSEC, pero esta especificaci칩n est치 poco implementada y hay problemas de seguridad y privacidad por permitir obtener todas las entradas DNS de un servidor<A
NAME="AEN443"
HREF="#FTN.AEN443"
><SPAN
CLASS="footnote"
>[4]</SPAN
></A
>.</P
><P
>Para usar IPsec hay que abrir en los cortafuegos el puerto 200 UDP, pues lo usa IKE. Tambi칠n hay que tener en cuenta que los paquetes tienen un n칰mero de protocolo distinto al IP (en concreto usa 50 y 51), por lo que tambi칠n podr칤a haber problemas en el cortafuegos.</P
><P
>El lado negativo de IPsec es que es una soluci칩n muy compleja<A
NAME="AEN447"
HREF="#FTN.AEN447"
><SPAN
CLASS="footnote"
>[5]</SPAN
></A
>, sobre todo lo que tiene que ver con la parte IKE. Al margen que esa complejidad podr치 afectar m치s o menos al usuario seg칰n los asistentes para configurar una VPN (el problema est치 en que todo se complica m치s si los sistemas operativos de los nodos a conectar son distintos<A
NAME="AEN449"
HREF="#FTN.AEN449"
><SPAN
CLASS="footnote"
>[6]</SPAN
></A
>, frente a la sencillez de usar una implementaci칩n de VPN m치s simple que tenga versi칩n para distintos sistemas operativos) desde el punto de vista de la seguridad son preferibles las soluciones sencillas. Hay gente que no le gusta tampoco de IPsec frente a otras soluciones que se ejecute mucho c칩digo en el espacio del kernel (por ejemplo la parte de cifrado, que en el caso de OpenVPN se ejecuta en el espacio de usuario) dado que un error de seguridad ah칤 es fatal al comprometer todo el sistema, si bien tiene un impacto positivo en el rendimiento. Esta objeci칩n es opinable: es cierto, pero tambi칠n la informaci칩n sensible est치 m치s protegida a nivel del kernel.</P
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="AEN451"
>6.2.1. Caso pr치ctico: IPsec en modo transporte, usando preshared keys</A
></H2
><P
>La IP de nuestra m치quina es 10.0.0.1 y queremos que haya conexiones seguras con otra m치quina de la red local, la 10.0.0.2. Vamos a crear la SA (Security Association) directamente con setkey, por lo que no necesitamos el demonio racoon, dado que no usamos IKE. Usaremos PSK (pre-shared keys). Para ello, creamos el siguiente fichero y lo grabamos como "politica.txt":
<PRE
CLASS="screen"
>add 10.0.0.1 10.0.0.2 esp 7320 -E 3des-cbc "i92dfafgehogexxxx1112222"; 
add 10.0.0.2 10.0.0.1 esp 6698 -E 3des-cbc "xxxXXXXXXrjZZZ(xx111z&#60;&#60;3";
spdadd 10.0.0.2 10.0.0.1 any -P out ipsec esp/transport//require;
</PRE
>
</P
><P
>Los n칰meros 7320 y 6698 son los SPI para identificar la SA; nos basta con elegir un entero de hasta 32 bits al azar, sabiendo que del 0 al 255 est치n reservados y que estos n칰meros tienen que ser 칰nicos por cada nodo.</P
><P
>La clave en cada sentido la hemos especificado para 3DES, que son 192bits, o lo que es lo mismo, 24 bytes; si especificamos la cadena como texto (otra opci칩n es como n칰mero hexadecimal, comenzando por 0x y sin entrecomillar) deber치 tener exactamente esa longitud.</P
><P
>Hay que ejecutar en la m치quina <KBD
CLASS="userinput"
>setkey -f politica.txt</KBD
>. Tras transferir el fichero a la m치quina 10.0.0.2 haremos lo mismo, pero tras invertir las direcciones en la 칰ltima l칤nea del fichero.</P
><P
>M치s casos pr치cticos, en el HOWTO: <A
HREF="http://lartc.org/howto/lartc.ipsec.html"
TARGET="_top"
>http://lartc.org/howto/lartc.ipsec.html</A
></P
></DIV
></DIV
><H3
CLASS="FOOTNOTES"
>Notas</H3
><TABLE
BORDER="0"
CLASS="FOOTNOTES"
WIDTH="100%"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN433"
HREF="x430.html#AEN433"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>En terminolog칤a IPsec se habla de Security Associations (SA) que incluyen los par치metros de seguridad como claves, certificados, algoritmos, duraci칩n de claves, datos para evitar replay attacs, etc.. En una comunicaci칩n hay una SA por sentido. En los paquetes se incluye un n칰mero, el SPI (Secure parameter index) que junto con la IP destino y el protocolo (AH o ESP) sirve para que la otra parte encuentre la SA en una tabla, la SADB. En cada nodo hay una SPD (Security Policy Database) que b치sicamente es una tabla que dados unos selectores (Ips/puertos origen/destino, por ejemplo) aplica una acci칩n, que puede ser dejar pasar el paquete tal cual o usar AH/ESP, modo transporte o modo t칰nel y la SA a aplicar. La implementaci칩n de Linux almacena en el kernel estas dos tablas.</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN435"
HREF="x430.html#AEN435"
><SPAN
CLASS="footnote"
>[2]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>En la versi칩n anterior de los RFC de IPsec, en realidad se hablaba de ISAKMP, para la gesti칩n de las SA, que para la parte del intercambio de claves pod칤a usar distintos protocolos, aunque en la pr치ctica se establec칤a IKE. En la versi칩n actual, IKE2, engloba todo.</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN441"
HREF="x430.html#AEN441"
><SPAN
CLASS="footnote"
>[3]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>StrongSWAN no es la 칰nica implementaci칩n libre de IKE2. Existe tambi칠n racoon2, ikv2 y el proyecto espa침ol openikev2 (http://openikev2.sourceforge.net/)</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN443"
HREF="x430.html#AEN443"
><SPAN
CLASS="footnote"
>[4]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>Hay m치s detalles de esto en la wikipedia. La idea b치sica es que los errores de no encontrado tambi칠n hay que firmarlos, pero como la clave privada no tiene por qu칠 estar online, estos mensajes pueden estar prefirmados; para que estos mensajes sean finitos, se indica que entre tal nombre y tal otro no existe esa entrada.</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN447"
HREF="x430.html#AEN447"
><SPAN
CLASS="footnote"
>[5]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>Hay 9 documentos para describir IPsec (RFC 4301-4309, de Diciembre de 2005, todav칤a es frecuente encontrar referencias a la versi칩n anterior de estos documentos, RFC 2401-2409 y a칰n hay otra m치s antigua, totalmente incompatible) m치s otros complementarios para explicar c칩mo traspasar los cortafuegos, as칤 como por ejemplo para especificar IPKMOBIL (para clientes con IP m칩vil y para m치quinas multihome) . De todos modos IKE2 simplifica IKE, a la par que evita algunos de sus problemas, en concreto denegaciones de servicio. Si o칤mos hablar de cosas como main vs agressive mode, se refieren a la versi칩n vieja, IKE.</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN449"
HREF="x430.html#AEN449"
><SPAN
CLASS="footnote"
>[6]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>Los problemas de interoperabilidad se dan practicamente siempre en la parte IKE. Son muchos los par치metros negociables y no hay unos valores por defecto que todas las implementaciones tengan que proporcionar. En la mayor칤a de los casos si algo sale mal no se muestra claramente la causa y si se muestra no es comprensible para alguien que no conozca a fondo IPsec. Para complicar m치s las cosas, IKE2 no es compatible con IKE1, aunque se pueden implementar los dos usando el mismo demonio y puerto UDP. As칤 mismo hay extensiones, por ejemplo en IKE con X-AUTHse pueden utilizar mecanismos adicionales de autenticaci칩n; en IKE2 se usa EAP (como en WPA/WPA2-Enterprise en las redes Wifi y en general en dispositivos que usen la autenticaci칩n de IEEE802.1X).</P
></TD
></TR
></TABLE
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="c395.html"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Inicio</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="x461.html"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Redes Privadas Virtuales (VPN)</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="c395.html"
ACCESSKEY="U"
>Subir</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>SSH + PPPD / SSH + TUN</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>