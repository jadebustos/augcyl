<?xml version='1.0' encoding='iso-8859-1'?>
<!-- CAPITULO 8 -->
  <chapter>
    <title>Gesti&oacute;n de sistemas de ficheros mediante <emphasis>LVM</emphasis></title>
    <para><emphasis>LVM</emphasis> permite una mejor y m&aacute;s flexible administraci&oacute;n de los sistemas de ficheros.</para>
    <para>Mediante el uso de almacenamiento externo, <emphasis>LVM</emphasis> y sistemas de ficheros como <emphasis>ext3</emphasis>, <emphasis>ReiserFS</emphasis> y <emphasis>XFS</emphasis> que permiten redimensionar <emphasis>en caliente</emphasis> tenemos una posibilidades de crecimiento y gesti&oacute;n de recursos de almacenamiento practicamente ilimitadas.</para>
    <important><para>En este cap&iacute;tulo se pretende introducir <emphasis>LVM</emphasis> para familiarizar al alumno con los conceptos b&aacute;sicos del manejo de volumenes de discos. No se entrar&aacute; a valorar las posibilidades de snapshots o clustering de <emphasis>LVM</emphasis>.</para></important>
    <sect1>
      <title>Volumenes f&iacute;sicos (physical volumes)</title>
      <para>Los <emphasis>volumenes f&iacute;sicos</emphasis> son los dispositivos f&iacute;sicos de almacenamiento. En base a estos se establece todo el sistema de gesti&oacute;n de <emphasis></emphasis>.</para>
      <para>Para poder utilizar un disco f&iacute;sico o una partici&oacute;n con <emphasis>LVM</emphasis> es necesario iniciarlizarla:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>pvcreate /dev/sda</userinput>
<computeroutput>  Physical volume "/dev/sda" successfully created</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <sect2>
      <title>Informaci&oacute;n y detecci&oacute;n de volumenes f&iacute;sicos</title>
      <para>Podemos utilizar el comando <command>pvscan</command> para buscar volumenes f&iacute;sicos:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>pvscan</userinput>
<computeroutput>  PV /dev/sda7   VG system_vg   lvm2 [107,59 GB / 26,13 GB free]
  Total: 1 [107,59 GB] / in use: 1 [107,59 GB] / in no VG: 0 [0   ]</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <para>Tambi&eacute;n disponemos del comando <command>pvdisplay</command> que nos ofrece m&aacute;s informaci&oacute;n sobre los volumenes encontrados:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>pvdisplay</userinput>
<computeroutput>  --- Physical volume ---
  PV Name               /dev/sda7
  VG Name               system_vg
  PV Size               107,59 GB / not usable 0   
  Allocatable           yes 
  PE Size (KByte)       4096
  Total PE              27544
  Free PE               6689
  Allocated PE          20855
  PV UUID               EcJiMO-20Ve-QVAz-yZvE-jN5e-tGrH-RtwyHB</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <important><para>El <emphasis>UUID</emphasis> es un identificador utilizado para se&ntilde;alar de forma &uacute;nica a cada volumen f&iacute;sico.</para></important>
    <para>El comando <emphasis>pvs</emphasis> tambi&eacute;n nos ofrece informaci&oacute;n:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>pvs</userinput>
<computeroutput>  PV         VG        Fmt  Attr PSize   PFree 
  /dev/sda7  system_vg lvm2 a-   107,59G 26,13G</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <para><emphasis>LVM</emphasis> proporciona el comando <command>lvmdiskscan</command> que nos inidicar&aacute; todos los discos visibles del sistema:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>lvmdiskscan</userinput>
<computeroutput>  /dev/ramdisk [       16,00 MB]
  /dev/dm-0    [       20,00 GB]
  /dev/ram     [       16,00 MB]
  /dev/sda1    [      101,94 MB]
  /dev/dm-1    [       20,00 GB]
  /dev/ram2    [       16,00 MB]
  /dev/sda2    [        4,00 GB]
  /dev/ram3    [       16,00 MB]
  /dev/root    [        1,50 GB]
  /dev/ram4    [       16,00 MB]
  /dev/ram5    [       16,00 MB]
  /dev/sda5    [        6,00 GB]
  /dev/ram6    [       16,00 MB]
  /dev/sda6    [        4,00 GB]
  /dev/ram7    [       16,00 MB]
  /dev/sda7    [        2,00 GB]
  /dev/ram8    [       16,00 MB]
  /dev/sda8    [        2,00 GB]
  /dev/ram9    [       16,00 MB]
  /dev/sda9    [        2,00 GB]
  /dev/ram10   [       16,00 MB]
  /dev/sda10   [       14,31 GB]
  /dev/ram11   [       16,00 MB]
  /dev/ram12   [       16,00 MB]
  /dev/ram13   [       16,00 MB]
  /dev/ram14   [       16,00 MB]
  /dev/ram15   [       16,00 MB]
  /dev/sdb     [       50,00 GB] LVM physical volume
  2 disks
  24 partitions
  1 LVM physical volume whole disks
  0 LVM physical volumes</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    </sect2>
    <sect2>
      <title>Eliminaci&oacute;n de volumenes f&iacute;sicos</title>
      <para>Podemos eliminar volumenes f&iacute;sicos con el comando <command>pvremove</command>.</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>pvremove /dev/sda</userinput>
<computeroutput>  Labels on physical volume "/dev/sda" successfully wiped</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    </sect2>
    </sect1>
    <sect1>
      <title>Grupos de volumen (volume groups)</title>
      <para>Los grupos de volumen son el equivalente a discos duros virtuales. Es decir un grupo de volumen estar&aacute; formado por uno o varios dispositivos f&iacute;sicos o particiones.</para>
      <para>Un grupo de volumen se crea de la siguiente forma:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>vgcreate data_vg /dev/sda /dev/sdb /dev/sdc5</userinput>
<computeroutput>  Volume group "data_vg" successfully created</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <para>De esta forma habremos creado un grupo de volumen, disco virtual, que estar&aacute; formado por los dispositivos f&iacute;sicos <emphasis>/dev/sda</emphasis>, <emphasis>/dev/sdb</emphasis> y la partici&oacute;n <emphasis>/dev/sdc5</emphasis>.</para>
    <para>Una vez hecho esto tendremos un directorio <filename>/dev/data_vg/</filename> en el cual se ir&aacute;n creando los ficheros de dispositivo que hacen referencia a las particiones l&oacute;gicas que creemos dentro de este grupo de volumen.</para>
    <sect2>
      <title>Informaci&oacute;n y detecci&oacute;n de grupos de volumen</title>
      <para>Podemos utilizar el comando <command>vgscan</command> para encontrar grupos de volumen:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>vgscan</userinput>
<computeroutput>  Reading all physical volumes. This may take a while...
  Found volume group "data_vg" using metadata type lvm2</computeroutput>
<prompt>[root@sal]#</prompt>
</screen>
    <para>Tambi&eacute;n disponemos del comando <command>vgdisplay</command> que nos ofrece m&aacute;s informaci&oacute;n sobre los grupos de volumen encontrados:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>vgdisplay</userinput>
<computeroutput>  --- Volume group ---
  VG Name               data_vg
  System ID
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  6
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               1
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               50,00 GB
  PE Size               4,00 MB
  Total PE              12799
  Alloc PE / Size       10240 / 40,00 GB
  Free  PE / Size       2559 / 10,00 GB
  VG UUID               JJ3bIX-tqSM-r8Qd-nt0b-jWm9-7O4n-YiZYBK</computeroutput>
<prompt>[root@sal]#</prompt>
</screen>
    <tip><para>Podemos ver informaci&oacute;n detallada sobre el grupo de volumen utilizando el flag <emphasis>-v</emphasis>.</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>vgdisplay -v</userinput>
<computeroutput>  --- Volume group ---
  VG Name               data_vg
  System ID
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  6
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               1
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               50,00 GB
  PE Size               4,00 MB
  Total PE              12799
  Alloc PE / Size       10240 / 40,00 GB
  Free  PE / Size       2559 / 10,00 GB
  VG UUID               JJ3bIX-tqSM-r8Qd-nt0b-jWm9-7O4n-YiZYBK

  --- Logical volume ---
  LV Name                /dev/data_vg/apache_lv
  VG Name                data_vg
  LV UUID                KCDc3t-jAHj-dNDK-I9qe-rF3B-oyya-Tg00JL
  LV Write Access        read/write
  LV Status              available
  # open                 1
  LV Size                20,00 GB
  Current LE             5120
  Segments               1
  Allocation             inherit
  Read ahead sectors     0
  Block device           253:0

  --- Logical volume ---
  LV Name                /dev/data_vg/mysql_lv
  VG Name                data_vg
  LV UUID                0m24gV-H9BC-MdbV-vSNZ-r57x-gx37-zUy22q
  LV Write Access        read/write
  LV Status              available
  # open                 0
  LV Size                20,00 GB
  Current LE             5120
  Segments               1
  Allocation             inherit
  Read ahead sectors     0
  Block device           253:1

  --- Physical volumes ---
  PV Name               /dev/sdd
  PV UUID               fKgSus-ts2y-vbR2-mTfy-YKPY-Aju1-C8SgV0
  PV Status             allocatable
  Total PE / Free PE    12799 / 2559</computeroutput>
<prompt>[root@sal]#</prompt>
</screen>
</tip>
    <para>El comando <command>vgs</command> tambi&eacute;n nos ofrece informaci&oacute;n:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>vgs</userinput>
<computeroutput>  VG      #PV #LV #SN Attr   VSize  VFree
  data_vg   1   2   0 wz--n- 50,00G 10,00G</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    </sect2>
    <sect2>
      <title>Ampliaci&oacute;n de un grupo de volumen</title>
      <para>Cuando nos quedamos sin espacio en un grupo de volumen siempre podemos ampliarlo utilizando m&aacute;s dispositivos f&iacute;sicos o particiones. Para ello utilizaremos el comando <command>vgextend</command>:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>vgextend data_vg /dev/sdd</userinput>
<computeroutput> Volume group "data_vg" successfully extended</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    </sect2>
       <sect2>
      <title>Reducci&oacute;n de un grupo de volumen</title>
      <para>Podemos quitar dispositivos f&iacute;sicos de un grupo de volumen, siempre y cuando no esten en uso.</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>vgreduce data_vg /dev/sdd</userinput>
<computeroutput>  Removed "/dev/sdd" from volume group "data_vg"</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    </sect2>
    <sect2>
      <title>Activaci&oacute;n y desactivaci&oacute;n de grupos de volumen</title>
      <para>Para poder utilizar los grupos de volumen es necesario que esten activos. Utilizaremos el comando <command>vgchange</command> para activarlos y desactivarlos.</para>
      <tip><para>El comando <command>vgchange</command> se utilizar para modificar los par&aacute;metros de los grupos de volumen.</para></tip>
    </sect2>
    <sect2>
      <title>Importaci&oacute;n y exportaci&oacute;n de grupos de volumen</title>
      <para>Hay ocasiones en las que es necesario mover discos entre diferentes m&aacute;quinas. Por ejemplo imaginemos que tenemos varias instancias de BBDD en una m&aacute;quina.</para>
      <para>La configuraci&oacute;n ideal para un entorno de este tipo es que cada instancia tenga sus datos en su propia partici&oacute;n y cada partici&oacute;n este en un grupo de volumen diferente. De esta forma si alguna de las instancias crece, en t&eacute;rminos de potencia, siempre es posible cambiar alguna instacia a otra m&aacute;quina.</para>
      <para>En este caso tendremos que exportar el grupo de volumen que queremos mover a otra m&aacute;quina y posteriormente importarlo.</para>
      <para>Ser&aacute; necesario desactivar todas las particiones l&oacute;gicas de ese grupo de volumen:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>lvchange -a n /dev/data_vg/mysql_lv</userinput>
<prompt>[root@sal]# </prompt><userinput>vgexport data_vg</userinput>
<computeroutput> Volume group "data_vg" successfully exported</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <para>Ahora podemos mover los dispositivos f&iacute;sicos que forman el grupo de volumen <emphasis>data_vg</emphasis> a otra m&aacute;quina e importarlos para poder utilizarlos:</para>
<screen>
<prompt>[root@pal]# </prompt><userinput>vgimport -a</userinput>
<computeroutput>  Volume group "data_vg" successfully imported</computeroutput>
<prompt>[root@pal]# </prompt>
</screen>
    </sect2>
    <sect2>
      <title>Eliminaci&oacute;n de un grupo de volumen</title>
      <para>Para poder eliminar un grupo de volumen necesitaremos que no est&eacute; en uso ninguna de las particiones l&oacute;gicas presentes y que este desactivado.</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>vgremove system_vg</userinput>
<computeroutput>  Volume group "system_vg" successfully removed</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    </sect2>
    </sect1>
    <sect1>
    <title>Particiones l&oacute;gicas (logical volumes)</title>
      <para>Las particiones l&oacute;gicas son particiones que se crean dentro de un volume group y podr&aacute;n crecer siempre y cuando hay espacio libre dentro del grupo de volumen.</para>
      <para>Una partici&oacute;n l&oacute;gica se crea:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>lvcreate -L5G -n mysql_lv /dev/data_vg</userinput>
<computeroutput>  Logical volume "mysql_lv" created</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <para>Habremos creado una partici&oacute;n l&oacute;gica de 5 gigas en el grupo de volumen <emphasis>data_vg</emphasis>.</para>
    <tip><para>Para formatearla, montarla, ... nos referiremos a ella como <filename>/dev/data_vg/mysql_lv</filename>.</para></tip>
    <sect2>
      <title>Informaci&oacute;n y detecci&oacute;n de particiones l&oacute;gicas</title>
      <para>Podemos utilizar el comando <command>lvscan</command> para encontrar particiones l&oacute;gicas:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>lvscan</userinput>
<computeroutput>  ACTIVE            '/dev/data_vg/apache_lv' [20,00 GB] inherit
  ACTIVE            '/dev/data_vg/mysql_lv' [20,00 GB] inherit</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <para>Tambi&eacute;n disponemos del comando <command>lvdisplay</command> que nos ofrece m&aacute;s informaci&oacute;n sobre las particiones l&oacute;gicas encontradas:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>lvdisplay</userinput>
<computeroutput>  --- Logical volume ---
  LV Name                /dev/data_vg/apache_lv
  VG Name                data_vg
  LV UUID                KCDc3t-jAHj-dNDK-I9qe-rF3B-oyya-Tg00JL
  LV Write Access        read/write
  LV Status              available
  # open                 1
  LV Size                20,00 GB
  Current LE             5120
  Segments               1
  Allocation             inherit
  Read ahead sectors     0
  Block device           253:0

  --- Logical volume ---
  LV Name                /dev/data_vg/mysql_lv
  VG Name                data_vg
  LV UUID                0m24gV-H9BC-MdbV-vSNZ-r57x-gx37-zUy22q
  LV Write Access        read/write
  LV Status              available
  # open                 0
  LV Size                20,00 GB
  Current LE             5120
  Segments               1
  Allocation             inherit
  Read ahead sectors     0
  Block device           253:1</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <para>El comando <command>lvs</command> tambi&eacute;n nos ofrece informaci&oacute;n:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>lvs</userinput>
<computeroutput>  LV        VG      Attr   LSize  Origin Snap%  Move Log Copy%
  apache_lv data_vg -wi-ao 20,00G
  mysql_lv  data_vg -wi-a- 20,00G</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    </sect2>
    <sect2>
      <title>Ampliaci&oacute;n de una partici&oacute;n l&oacute;gica</title>
      <para></para>
<screen>
<prompt>[root@sal]# </prompt><userinput>lvextend -L+2G /dev/data_vg/mysql_lv</userinput>
<computeroutput>  Extending logical volume mysql_lv to 7,00 GB
  Logical volume mysql_lv successfully resized</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <para>Una vez ampliada la partici&oacute;n l&oacute;gica habr&aacute; que hacer un resize. Si es sistema de ficheros es <emphasis>ReiserFS</emphasis> podemos hacerlo en caliente sin desmontarlo:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>resize_reiserfs /dev/data_vg/mysql_lv</userinput>
<computeroutput>  resize_reiserfs 3.6.19 (2003 www.namesys.com)
  

  resize_reiserfs: On-line resize finished successfully.</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    <para>Con <emphasis>ext3</emphasis>:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>ext2online /dev/data_vg/mysql_lv</userinput>
<computeroutput>ext2online v1.1.18 - 2001/03/18 for EXT2FS 0.5b</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    </sect2>
    <sect2>
      <title>Reducci&oacute;n de tama&ntilde;o para particiones l&oacute;gicas</title>
      <warning><para>Antes de reducir un sistema de ficheros es MUY recomendable asegurarse de que hay un backup de los datos.</para></warning>
      <warning><para>Si el sistema de ficheros est&aacute; fragmentado y existen datos en la parte a reducir esos datos se perder&aacute;n.</para></warning>
      <warning><para>Cuando reduzcamos un sistema de ficheros tenemos que asegurarnos de que el sistema de ficheros resultante puede contener todos los datos.</para></warning>
      <para>Los pasos a seguir son:</para>
      <itemizedlist>
        <listitem>
          <para>Desmontar la partici&oacute;n.</para>
        </listitem>
        <listitem>
          <para>Hacer un resize del sistema de ficheros al tama&ntilde;o deseado.</para>
          <para>Con un sistema de ficheros <emphasis>ReiserFS</emphasis>:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>resize_reiserfs -s -1G /dev/data_vg/mysql_lv</userinput>
<computeroutput>Dando formato a resize_reiserfs(8); aguarde, por favor...
telemaco:/media# resize_reiserfs -s -1G /dev/data_vg/mysql_lv 
resize_reiserfs 3.6.19 (2003 www.namesys.com)

You are running BETA version of reiserfs shrinker.
This version is only for testing or VERY CAREFUL use.
Backup of you data is recommended.

Do you want to continue? [y/N]:<userinput>y</userinput>
Processing the tree: 0%....20%....40%....60%....80%....100%                      left 0, 105322 /sec

nodes processed (moved):
int        3 (0),
leaves     209 (0),
unfm       210432 (0),
total      210644 (0).

check for used blocks in truncated region

ReiserFS report:
blocksize             4096
block count           1048576 (1310720)
free blocks           829690 (1091826)
bitmap block count    32 (40)

Syncing..done


resize_reiserfs: Resizing finished successfully.</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
        <para>Con un sistema de ficheros <emphasis>ext3</emphasis>:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>e2fsck -f /dev/data_vg/mysql_lv</userinput>
<computeroutput>e2fsck 1.35 (28-Feb-2004)
Paso 1: revisando nodos i, bloques y tama&ntilde;os
Paso 2: revisando la estructura de directorios
Paso 3: revisando la conectividad del directorio.
Paso 4: revisando las cuentas de referencia
Paso 5: revisando el resumen de informaci&oacute;n del grupo
/dev/data_vg/mysql_lv: ficheros 11/92160 (9.1% no contiguos), bloques 7156/179200</computeroutput>
<prompt>[root@sal]# </prompt><userinput>resize2fs /dev/data_vg/mysql_lv 6g</userinput>
<computeroutput>resize2fs 1.35 (28-Feb-2004)
Resizing the filesystem on /dev/data_vg/mysql_lv to 2816000 (4k) blocks.
El sistema de ficheros en /dev/data_vg/mysql_lv mide ahora 2816000 bloques.</computeroutput>
</screen>
        </listitem>
        <listitem>
          <para>Reducimos la partici&oacute;n l&oacute;gica:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>lvreduce -L-1G /dev/data_vg/mysql_lv</userinput>
<computeroutput>  WARNING: Reducing active logical volume to 6,00 GB
  THIS MAY DESTROY YOUR DATA (filesystem etc.)
Do you really want to reduce mysql_lv? [y/n] <userinput>y</userinput>
  Logical volume mysql_lv successfully resized</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
        </listitem>
      </itemizedlist>
    </sect2>
    <sect2>
      <title>Activaci&oacute;n y desactivaci&oacute;n de particiones l&oacute;gicas</title>
      <para>Para determinadas operaciones de los grupos de volumen es necesario desactivar las particiones l&oacute;gicas que en ellos residen.</para>
      <para>Utilizaremos para ello el comando <command>lvchange</command>:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>lvchange -a n /dev/data_vg/mysql_lv</userinput>
<prompt>[root@sal]# </prompt>
</screen>
    <para>Desactivar&iacute;a la partici&oacute;n l&oacute;gica.</para>
    <tip><para><command>man lvchange</command></para></tip>
    </sect2>
    <sect2>
      <title>Eliminaci&oacute;n de una partici&oacute;n l&oacute;gica</title>
      <para>Para eliminar una partici&oacute;n l&oacute;gica utilizaremos el comando <command>lvremove</command>:</para>
<screen>
<prompt>[root@sal]# </prompt><userinput>lvremove /dev/data_vg/mysql_lv</userinput>
<computeroutput>Do you really want to remove active logical volume "mysql_lv"? [y/n]: <userinput>y</userinput>
  Logical volume "mysql_lv" successfully removed</computeroutput>
<prompt>[root@sal]# </prompt>
</screen>
    </sect2>
    </sect1>
  </chapter>