<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Caso pr치ctico: router red local, red otra empresa, Internet</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="GNU/Linux, software libre para la comunidad universitaria"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Netfilter/IPtables. Soluci칩n para crear cortafuegos, auditar red y hacer NAT"
HREF="x649.html"><LINK
REL="NEXT"
TITLE="Soluciones de virtualizaci칩n/redes con virtualizadores"
HREF="c748.html"></HEAD
><BODY
CLASS="chapter"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>GNU/Linux, software libre para la comunidad universitaria: Redes privadas virtuales en GNU/Linux</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="x649.html"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="c748.html"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="chapter"
><H1
><A
NAME="AEN724"
></A
>Cap狎ulo 9. Caso pr치ctico: router red local, red otra empresa, Internet</H1
><P
>Supongamos la red local de una empresa, d칩nde hay un enrutador que tiene que comunicar estas redes entre s칤:</P
><P
></P
><OL
TYPE="1"
><LI
><P
>red local con los equipos de los usuarios y servidores de impresi칩n. Est치n todos en la red 192.168.120.0/24</P
></LI
><LI
><P
>red local de otra empresa del parque tecnol칩gico con la que colaboran un grupo de usuarios. Esta red es 10.2.0.0/16. La otra empresa ha pedido que los equipos de la red local no vean directamente su router, sino que haya un enlace punto a punto entre los servidores de las dos redes. Las Ips ser치n visibles en ambas redes, es decir, desde 192.168.120.* se ver치n las Ips de 10.2.*.* y viceversa.</P
></LI
><LI
><P
>acceso a Internet con router ADSL. Hay una 칰nica direcci칩n IP, luego habr치 que hacer NAT con configuraci칩n multipuesto, aunque tambi칠n podr칤amos ponerlo en multipuesto y que el NAT lo haga la m치quina Linux que act칰a de router.</P
></LI
></OL
><P
>Para esta configuraci칩n necesitamos tres tarjetas de red para la m치quina Linux que har치 de router: una ser치 para la red local (192.168.120.0/24), otra para conectarse con la red de la empresa y una tercera para el router ADSL para la conexi칩n a Internet. 쯅os las pod칤amos haber apa침ado con una sola tarjeta utilizando ipalias? pues realmente s칤. El problema es que no es la configuraci칩n m치s adecuada, pues lo deseable es que desde la red local no accedan directamente a Internet ni a la red de la otra empresa y desde luego separar tambi칠n Internet y la red de la otra empresa y poder poner cortafuegos en medio. Si se usa una 칰nica red f칤sica no hay tal separaci칩n y cualquier nodo podr칤a tratar de espiar la red. En una infraestructura de red con switchs que soporten VLANs s칤 es viable usar una 칰nica tarjeta de red y sin necesidad de ipalias, sino creando tres VLANs distintas y configurando el puerto del switch al que est치 conectado el router como un Trunk port con acceso a las tres VLANs.</P
><P
>Tanto para conectarnos con la red de la otra empresa como con el router ADSL, utilizamos sendas redes con m치scara de 30 bits, es decir de dos nodos. Por ejemplo con la red 192.168.200.84/30 nuestro nodo tendr치 la IP 192.168.200.85 y el otro router la 192.168.200.86.</P
><DIV
CLASS="sect1"
><H1
CLASS="sect1"
><A
NAME="AEN736"
>9.1. El problema de la IP de origen en m치quinas multihome (con m치s de una IP).</A
></H1
><P
>Los encaminadores tienen m치s de una direcci칩n IP, dado que tienen una IP en cada interfaz de red que encaminan. Ahora bien, cuando una m치quina que tiene varias direcciones IP se comunica con otra m치quina 쯤u칠 IP origen figura en los paquetes? la IP de la interfaz de red por la que saldr치 el paquete.</P
><P
>Esto puede ser problem치tico en algunos casos. Por ejemplo en nuestra configuraci칩n, en la interfaz eth1 que conecta nuestra red con la red de otra empresa. Resulta que los equipos de la red de la otra empresa no saben c칩mo llegar a 192.168.200.86: los equipos de ambas redes conocen las Ips 192.168.120.0 y 10.0.0.0, pero no conocen la red 192.168.200.84/30, que es un artificio para comunicar los dos enrutadores. As칤 pues, cualquier paquete que proceda de nuestro enrutador y vaya a una direcci칩n de la red 10.0.0.0 llevar치 como IP origen 192.168.200.86, por lo que podr치 llegar a destino pero luego no llegar치n los paquetes respuesta. Podemos hacer una prueba muy sencilla: un simple ping a una m치quina de la red 10.0.0.0 y veremos que la IP origen es 192.168.20.86 y no nos llega la respuesta, mientras que desde otra IP de la red s칤.</P
><P
>La soluci칩n pasa por utilizar como IP origen 192.168.120.19 tambi칠n cuando los paquetes vayan a la red 10.0.0.0 y no s칩lo cuando vayan a la red local. Ante esto caben dos enfoques:</P
><P
></P
><OL
TYPE="1"
><LI
><P
>Configurar cada programa que necesita contactar con la red 10 para que use la IP 192.168.120.19. Cada programa se configura de forma distinta. Por ejemplo con un ping basta indicar la IP con la opci칩n -I, con SSH se indica mediante la opci칩n BindAddress...</P
></LI
><LI
><P
>Hacer NAT: mediante iptables ponemos una regla para que todo paquete con la direcci칩n origen 192.168.200.86 que vaya a salir por la interfaz eth1 cambie su IP a 192.168.120.19. Esta regla ser칤a:
<KBD
CLASS="userinput"
>iptables -t nat -A POSTROUTING --source 192.168.200.86 -o eth1 -j SNAT --to-source 192.168.120.19</KBD
></P
></LI
></OL
><P
>쯈u칠 soluci칩n es m치s apropiada? Depende. La segunda obviamente es m치s directa, pues no hay que cambiar programa a programa. Ahora bien, por seguridad desde el enrutador no se deber칤a acceder a m치s equipos de la otra red que los imprescindibles, por ejemplo los servidores DNS. Obligarse a reconfigurar cada programa que hay lo necesita es obligarse a mantener controlado a qu칠 servicios de la otra red estamos accediendo desde el router.</P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="x649.html"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Inicio</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="c748.html"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Netfilter/IPtables. Soluci칩n para crear cortafuegos, auditar red y hacer NAT</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Soluciones de virtualizaci칩n/redes con virtualizadores</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>