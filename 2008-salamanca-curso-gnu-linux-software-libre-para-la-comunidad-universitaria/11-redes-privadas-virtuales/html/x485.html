<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>OpenVPN</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="GNU/Linux, software libre para la comunidad universitaria"
HREF="index.html"><LINK
REL="UP"
TITLE="Redes Privadas Virtuales (VPN)"
HREF="c380.html"><LINK
REL="PREVIOUS"
TITLE="SSH con TUN"
HREF="x473.html"><LINK
REL="NEXT"
TITLE="Escritorio remoto"
HREF="c543.html"></HEAD
><BODY
CLASS="sect1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>GNU/Linux, software libre para la comunidad universitaria: Redes privadas virtuales en GNU/Linux</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="x473.html"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Cap狎ulo 6. Redes Privadas Virtuales (VPN)</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="c543.html"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="sect1"
><H1
CLASS="sect1"
><A
NAME="AEN485"
>6.5. OpenVPN</A
></H1
><P
>El hecho de usar protocolos conocidos y una librer칤a muy probada como OpenSSL da mucha fiabilidad a este programa: es relativamente f치cil fallar estrepitosamente a la hora de tratar de crear un nuevo sistema de VPN, como revela este interesante escrito de Peter Gutmann (el autor de cryptolib y la impresionante presentaci칩n/tutorial de criptograf칤a de m치s de 800 transparencias)</P
><P
>que habla de CIPE, VTUN y TINC: <A
HREF="http://www.cs.auckland.ac.nz/~pgut001/pubs/linux_vpn.txt"
TARGET="_top"
>http://www.cs.auckland.ac.nz/~pgut001/pubs/linux_vpn.txt</A
>. Del mismo autor, un art칤culo m치s elaborado sobre el tema: http://www.linux-magazine.com/issue/39/VPN_Insecurity.pdf</P
><P
>OpenVPN consta de un 칰nico ejecutable (para ambos extremos es el mismo) y un fichero opcional de configuraci칩n, adem치s de los ficheros de claves.</P
><P
>Uno de los puntos fuertes es que es multiplataforma: el poder usar exactamente el mismo programa en GNU/Linux, cualquier BSD, Solaris, Mac OS X o Windows XP/2000 supone hacer una VPN en la que intervengan equipos con cualquier sistema operativo sin problemas de interoperabilidad.</P
><P
>OpenVPN permite hacer t칰neles a nivel de la capa 3 (la opci칩n por defecto y la recomendada, se usa un dispositivo TUN) o a nivel de la capa 2 (usando un dispositivo TAP). Si usamos la capa 2, podemos utilizar un puente. S칩lo tiene sentido usar la capa 2 en casos especiales, principalmente si necesitamos un puente o vamos a transferir distintos tipos de tr치fico (IP, IPX...) simultaneamente. Por ejemplo es 칰til utilizar un puente para tener una IP propia asignada por un servidor DHCP en la red remota, aunque es posible lograrlo (con m치s trabajo) utilizando proxyarp o usar un proxy de DHCP.</P
><P
>Una funcionalidad interesante de OpenVPN desde su versi칩n 2.0 es crear un 칰nico servidor al que pueden conectarse distintos clientes, para crear cada uno su propia red privada virtual con la red local en la que est치 el servidor; en este modo adem치s el servidor puede pasar configuraci칩n al cliente, incluyendo opciones DHCP. El modo servidor de OpenVPN requiere el uso de certificados, en cambio en el modo tradicional (peer2peer) se pueden usar certificados o claves compartidas; en este 칰ltimo caso no se utiliza TLS ni criptograf칤a de clave p칰blica.</P
><P
>OpenVPN no soporta STUN ni TURN para superar problemas en el caso de que las dos partes est칠n tras NAT, pero en su defecto soporta SOCKS, como proxy UDP.</P
><P
>OpenVPN se adapta muy bien al caso de sitios con IP cambiante que usan DNS din치mico. Tiene una opci칩n para reiniciarse si la otra parte no responde a unos pings peri칩dicos, para volver a establecer la conexi칩n.</P
><P
>El programa incluye un gran n칰mero de opciones: limitar ancho de banda, autenticar por usuario y contrase침a adem치s de por certificado, listas de revocaci칩n de certificados... As칤 mismo se puede usar con una smartcard (actualmente en la versi칩n beta s칩lo).</P
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="AEN497"
>6.5.1. Caso pr치ctico: OpenVPN</A
></H2
><P
>Supongamos que queremos conectarnos las m치quinas con IP p칰blicas 83.59.36.220 y 81.33.18.197. La primera tiene abierto en el cortafuegos el puerto UDP 9037, mientras que la segunda tiene el 1198. Vamos a crear una red privada virtual, en el que el primer nodo tendr치 la IP 10.4.0.2 y el segundo el 10.4.0.1.</P
><P
>La configuraci칩n m치s sencilla de manejo de una clave com칰n es utilizar una clave compartida. Para ello en primer lugar la generamos en uno de los nodos:
<KBD
CLASS="userinput"
>openvpn --genkey --secret static.key</KBD
></P
><P
>A continuaci칩n la subiremos al otro nodo utilizando alg칰n procedimiento seguro. Por ejemplo con scp (parte de SSH). Hecho esto ya podemos crear la VPN:</P
><P
>En el nodo 81.33.18.197, ejecutamos:

<KBD
CLASS="userinput"
>openvpn --remote 83.59.36.220 --rport 9037 --lport 1198 --dev tun1 --ifconfig 10.4.0.1 10.4.0.2 -secret static.key 0</KBD
></P
><P
>En el nodo 83.59.36.220 ejecutamos:

<KBD
CLASS="userinput"
>openvpn --remote 81.33.18.197 --rport 1198 --lport 9037 --dev tun1 --ifconfig 10.4.0.2 10.4.0.1 --secret static.key 1</KBD
></P
><P
>El n칰mero que sigue a static.key simplemente tiene que ser distinto en cada lado; se utiliza para que se utilicen dos pares de claves en la sesi칩n en lugar de un solo par.</P
><P
>En ambos nodos ejecutamos:
<KBD
CLASS="userinput"
>echo 1 &#62; /proc/sys/net/ipv4/ip_forward &#38;
iptables -I FORWARD -i tun+ -j ACCEPT</KBD
></P
><P
>La primera l칤nea es para activar el forwarding entre interfaces de red, o lo que es lo mismo, la posibilidad de enrutado. La segunda l칤nea es para evitar que rechace el cortafuegos el tr치fico procedente de la interfaz tun. En esta l칤nea hemos puesto I (Insert) en lugar de A (append) como viene en la documentaci칩n. Realmente es m치s apropiado append, puesto que as칤 si hay reglas espec칤ficas para filtrar no nos las saltaremos, pero para probar primero que podemos establecer conexi칩n puede ser buena idea poner la regla la primera.</P
><P
>Una vez que veamos que todo funciona, podemos invocar estos programas con la opci칩n --daemon.</P
><P
>Si no hemos logrado conectar, posiblemente haya un problema con el cortafuegos. Podemos probar con la herramienta netcat a enviar/escuchar paquetes en estos puertos UDP.</P
><P
>As칤, en 83.59.36.220 ejecutamos:
<KBD
CLASS="userinput"
>netcat -u -l -p 9037</KBD
></P
><P
>en 81.33.18.197 ejecutamos:
<KBD
CLASS="userinput"
>netcat -u 83.59.36.220 9037</KBD
></P
><P
>A continuaci칩n escribimos algo: deber치 aparecer en 83.59.36.220 y lo que escribamos all칤 aparecer en 81.33.18.197.</P
><P
>El uso de una clave compartida no es el m칠todo m치s seguro. Por ejemplo si se compromete la clave se comprometen todas las conversaciones pasadas. No es un sistema de "perfect forward security". Aclaremos que hay sistemas basados en PSK (Preshared keys) que s칤 lo son, pero no as칤 el de OpenVPN. La diferencia es que en algunos sistemas las PSK hacen las mismas funciones que los certificados en TLS: sirven para autentificar a la otra parte, no para obtener la clave de sesi칩n, que se determina utilizando Diffie-Hellman. En cambio con OpenVPN sirven para establecer la clave de sesi칩n.</P
><P
>Es posible usar proxyarp tambi칠n con OpenVPN, lo que ocurre es que la forma de activarlo s칤 que es dependiente del sistema operativo y habr치 sistemas que ni siquiera lo soporten. En el caso de Linux ser칤a con:
<KBD
CLASS="userinput"
>echo 1 &#62; /proc/sys/net/ipv4/conf/all/proxy_arp</KBD
></P
><P
>Por supuesto tambi칠n es posible activar proxy_arp a nivel de cada dispositivo de red, igual que en el caso del fordwarding. Como en el caso del forwarding, deben activarse todas las interfaces implicadas, esto es, tanto la interfaz por la que llega la pregunta como la interfaz de la que se recibe la respuesta.</P
><P
>No es necesario especificar --remote y --rport en los dos extremos, basta con hacerlo en uno (esto es 칰til para especificarlo s칩lo en el extremo que no tiene un puerto abierto en el router, se recomienda en este caso usar as칤 mismo --nobind). El extremo en el que lo especifiquemos trata de contactar con el otro (se puede indicar varias veces con datos distintos y lo intentar치 secuencialmente con cada uno hasta lograrlo). Ahora bien, si lo especificamos OpenVPN dar치 un error si recibe un paquete de una IP o puerto distinto a alguno de los especificados. Si la IP de la otra parte puede cambiar es conveniente no usar --remote o usar --float. Un detalle cuando se usa --remote y el puerto remoto est치 redirigido a un puerto UDP distinto al del router, es que entonces los paquetes tendr치n un puerto origen distinto al que ve la otra parte como destino, salvo que enviara antes la otra parte un paquete y el NAT del router modifique el puerto origen.</P
><P
>Otra raz칩n para no usar --remote en uno de los dos extremos, es si por ejemplo accedemos desde nuestra casa y unas veces usamos un PC y otras otro, por lo que no podemos utilizar siempre el mismo puerto. Pero ojo, no debemos conectarnos desde dos clientes distintos a la vez, salvo que usemos el modo servidor.</P
><P
>Usar certificados en lugar de claves compartidas no es complicado en OpenVPN, gracias a la mini autoridad de certificaci칩n de prueba que incluye (en Ubuntu est치 en el directorio de documentaci칩n, en el subdirectorio easy-rsa). Situados en este directorio, ejecutamos: 
<KBD
CLASS="userinput"
>source vars ; ./clean_all ; build-ca</KBD
></P
><P
>Con esto ya tenemos creado el certificado y clave privada de la autoridad de certificaci칩n. Para generar el certificado y clave privada del servidor (en el supuesto que queramos modo servidor, de otro modo da igual generar todos los certificados clientes):
<KBD
CLASS="userinput"
>./build-key-pkcs12 --server server</KBD
></P
><P
>Para generar un certificado para un cliente:
<KBD
CLASS="userinput"
>./build-key-pkcs12 cliente1</KBD
></P
><P
>Generamos los par치metros DH, que deberemos pasar al lado que funciona como servidor TLS:
<KBD
CLASS="userinput"
>./build-dh</KBD
></P
><P
>En la m치quina que va a funcionar como servidor TLS ejecutamos:
<KBD
CLASS="userinput"
>openvpn --dev tun2 --remote 192.168.1.131 --ifconfig 10.5.0.2 10.5.0.1 --pkcs12 server.p12 --tls-server --dh dh1024.pem</KBD
> </P
><P
>En la m치quina que va a funcionar como cliente TLS ejecutamos:
<KBD
CLASS="userinput"
>openvpn --dev tun2 --remote 192.168.1.130 --ifconfig 10.5.0.1 10.5.0.2 --pkcs12 keys/cliente1.p12 --tls-client --ns-cert-type server</KBD
> </P
><P
>Para finalizar, un ejemplo de uso del modo servidor. M치quina servidor:
<KBD
CLASS="userinput"
>openvpn --dev tun2 --server 10.5.0.0 255.255.0.0 --pkcs12 server.p12 --tls-server --dh dh1024.pem</KBD
></P
><P
>M치quina cliente:
<KBD
CLASS="userinput"
>openvpn --dev tun2 --remote 192.168.1.130 --client --pkcs12 keys/cliente1.p12 --tls-client --ns-cert-type server</KBD
></P
><P
>El cliente obtendr치 una IP en el rango indicado por el servidor; la IP del servidor ser치 la x.x.x.1. Por defecto dos clientes que se conecten no podr치n verse, salvo que se active una opci칩n o el servidor a침ada reglas de enrutado. La opci칩n ns-cert-type est치 para evitar que otro cliente con un certificado v치lido firmado por la CA se haga pasar por el servidor.</P
><P
>Con certificados, una opci칩n recomendable es a침adir la opci칩n -tls-auth, con una clave compartida. Esta opci칩n sirve para que el cliente tenga que proporcionar la clave compartida para poder continuar. Con esto se evitan ataques de denegaci칩n de servicio y posibles incidencias si un d칤a se descubre un bug en openssl.</P
><P
>OpenVPN permite crear/usar/borrar un dispositivo TUN persistente, en lugar de crearlo al establecer la conexi칩n y destruirlo al acabarla.</P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="x473.html"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Inicio</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="c543.html"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>SSH con TUN</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="c380.html"
ACCESSKEY="U"
>Subir</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Escritorio remoto</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>