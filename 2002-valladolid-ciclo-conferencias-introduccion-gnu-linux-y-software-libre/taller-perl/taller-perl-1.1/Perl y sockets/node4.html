<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="Author" content="Francisco J. Palacios">
   <title>Taller de Perl - Sockets</title>
</head>
<body background="fondo.jpg">

<div align=right><img SRC="camel.gif" height=149 width=144></div>

<h3>
5. Comunicaci&oacute;n bidireccional</h3>

<p><br>El ejemplo anterior consist&iacute;a en un cliente que se conectaba
a un servidor y &eacute;ste autom&aacute;ticamente le proporcionaba un
servicio. Aunque hay ejemplos de este tipo de&nbsp; esquemas los casos
reales suelen caracterizarse por una comunicaci&oacute;n bi-direccional,
apoy&aacute;ndose &eacute;sta en el uso de alg&uacute;n protocolo (conjunto
de reglas acordadas entre las partes que se comunican). En los siguientes
ejemplos se ha modificado el cliente y el servidor para que se comuniquen
mediante un protocolo sencillo:
<br>&nbsp;
<p>El Cliente (<font color="#000000"><a href="client1.pl">client1.pl</a></font>)
<table BORDER COLS=1 WIDTH="100%" BGCOLOR="#FFFFCC" NOSAVE >
<tr NOSAVE>
<td NOSAVE><font color="#993399">#!/usr/bin/perl -w</font>
<p><font color="#3333FF"># Modelo de cliente con comunicacion bidireccional</font>
<p>use <font color="#006600">Socket</font>;
<p><font color="#006600">$host</font> = <font color="#006600">$ARGV[</font><font color="#993399">0</font><font color="#006600">]</font>;
<br><font color="#006600">$port</font> = <font color="#006600">$ARGV[</font><font color="#993399">1</font><font color="#006600">]</font>;
<p><font color="#3333FF"># 1. Creamos el tipo de socket TCP. Si no nos
sabemos el numero del TCP lo</font>
<br><font color="#3333FF"># podemos preguntar con la siguiente funcion</font>
<br><font color="#006600">$proto</font> = getprotobyname(<font color="#FF0000">'tcp'</font>);
<br>socket(S,AF_INET,SOCK_STREAM,<font color="#006600">$proto</font>) ||
die <font color="#FF0000">"socket: </font><font color="#006600">$!</font><font color="#FF0000">"</font>;&nbsp;
<font color="#3333FF"># $!(tipo de error)</font>
<br>print <font color="#FF0000">"Creacion del socket del lado del cliente.</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<p><font color="#3333FF"># 2. Se empaquetan las direcciones local y remota
en el formato que piden</font>
<br><font color="#3333FF"># la funcion bind y la funcion connect. Si para
el host se dio su nombre</font>
<br><font color="#3333FF"># en vez de su IP habra que obtener su IP con
la funcion gethostbyname</font>
<br>(<font color="#006600">$name</font>, <font color="#006600">$aliases</font>,<font color="#006600">$type</font>,<font color="#006600">$len</font>,<font color="#006600">$local</font>)
= gethostbyname(<font color="#FF0000">'localhost'</font>);
<br>(<font color="#006600">$name</font>, <font color="#006600">$aliases</font>,<font color="#006600">$type</font>,<font color="#006600">$len</font>,<font color="#006600">$remote</font>)
= gethostbyname(<font color="#006600">$host</font>);
<p><font color="#3333FF"># 3. Se empaquetan las direcciones en el formato
requerido</font>
<br><font color="#006600">$sockaddr</font> = <font color="#FF0000">'S n
a4 x8'</font>;
<br><font color="#006600">$localaddr</font>&nbsp; = pack(<font color="#006600">$sockaddr</font>,
AF_INET, <font color="#993399">0</font>, <font color="#006600">$local</font>);
<br><font color="#006600">$remoteaddr</font> = pack(<font color="#006600">$sockaddr</font>,
AF_INET, <font color="#006600">$port</font>, <font color="#006600">$remote</font>);
<p><font color="#3333FF"># 4. Se asocia el socket y se conecta con la direccion
dada</font>
<br>bind(S, <font color="#006600">$localaddr</font>) || die <font color="#FF0000">"bind:
</font><font color="#006600">$!</font><font color="#FF0000">"</font>;
<br>print <font color="#FF0000">"Intentando conectarme a </font><font color="#006600">$host</font><font color="#FF0000">
por el puerto $port</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<br>connect(S, <font color="#006600">$remoteaddr</font>) || die <font color="#FF0000">"connect:
</font><font color="#006600">$!</font><font color="#FF0000">"</font>;
<br>select S; <font color="#006600">$|</font> = <font color="#993399">1</font>;
select STDOUT;
<p><font color="#3333FF"># 5. Le pedimos un servicio en este caso la hora
mandandole una peticion</font>
<br>print S <font color="#FF0000">"__TIME</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<br>select S; <font color="#006600">$|</font> = <font color="#993399">1</font>;
select STDOUT;
<br>print <font color="#FF0000">"Mandado al servidor el mensaje __TIME</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<br><font color="#006600">$resp</font> = &lt;S>;
<br>chop <font color="#006600">$resp</font>;
<br>if(<font color="#006600">$resp</font> eq <font color="#FF0000">"__TIME"</font>)
<br>{
<br>&nbsp;&nbsp; <font color="#006600">$resp</font> = &lt;S>;
<br>&nbsp;&nbsp; chop <font color="#006600">$resp</font>;
<br>&nbsp;&nbsp; print <font color="#FF0000">"Respuesta del servidor: </font><font color="#006600">$resp</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<br>}
<br>elsif(<font color="#006600">$resp</font> eq <font color="#FF0000">"__BUSY"</font>)
<br>{
<br>&nbsp;&nbsp; print <font color="#FF0000">"Servidor ocupado. Terminando</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<br>}
<p><font color="#3333FF"># Finalmente se cierra el socket</font>
<br>close(S) || die <font color="#FF0000">"close: </font><font color="#006600">$!</font><font color="#FF0000">"</font>;
<br>exit;</td>
</tr>
</table>

<br>&nbsp;
<p>y el servidor correspondiente (<font color="#000000"><a href="server1.pl">server1.pl</a></font>)
<table BORDER COLS=1 WIDTH="100%" BGCOLOR="#FFFFCC" NOSAVE >
<tr NOSAVE>
<td NOSAVE><font color="#993399">#!/usr/bin/perl -w</font>
<p><font color="#3333FF"># Modelo de servidor con comunicacion bidireccional</font>
<p>use <font color="#006600">Socket</font>;
<p><font color="#006600">$port</font> = <font color="#006600">$ARGV[</font><font color="#993399">0</font><font color="#006600">];</font>
<p><font color="#3333FF"># 1. Creamos el tipo de socket TCP. Si no nos
sabemos el numero del TCP lo</font>
<br><font color="#3333FF"># podemos preguntar con la siguiente funcion</font>
<br><font color="#006600">$proto</font> = getprotobyname(<font color="#FF0000">'tcp'</font>);
<br>socket(S,AF_INET,SOCK_STREAM,<font color="#006600">$proto</font>) ||
die <font color="#FF0000">"socket: </font><font color="#006600">$!</font><font color="#FF0000">"</font>;&nbsp;
<font color="#3333FF"># $!(tipo de error)</font>
<br>print <font color="#FF0000">"Creacion del socket del lado del servidor.</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<p><font color="#3333FF"># 2. Se empaquetan las direcciones local y remota
en el formato que piden</font>
<br><font color="#3333FF"># la funcion bind y la funcion connect. Si para
el host se dio su nombre</font>
<br><font color="#3333FF"># en vez de su IP habra que obtener su IP con
la funcion gethostbyname</font>
<br>(<font color="#006600">$name</font>, <font color="#006600">$aliases</font>,<font color="#006600">$type</font>,<font color="#006600">$len</font>,<font color="#006600">$local</font>)
= gethostbyname(<font color="#FF0000">'localhost'</font>);
<p><font color="#3333FF"># 3. Se empaquetan las direcciones en el formato
requerido</font>
<br><font color="#006600">$sockaddr</font> = <font color="#FF0000">'S n
a4 x8'</font>;
<br><font color="#006600">$localaddr</font>&nbsp; = pack(<font color="#006600">$sockaddr</font>,
AF_INET, <font color="#006600">$port</font>, <font color="#006600">$local</font>);
<p><font color="#3333FF"># 4. Se asocia el socket&nbsp;</font>
<br>bind(S, <font color="#006600">$localaddr</font>) || die <font color="#FF0000">"bind:
</font><font color="#006600">$!</font><font color="#FF0000">"</font>;
<br>listen(S,<font color="#993399">10</font>) || die <font color="#FF0000">"listen:
</font><font color="#006600">$!</font><font color="#FF0000">"</font>;
<br>print <font color="#FF0000">"Servidor escuchando en el puerto </font><font color="#006600">$port</font><font color="#FF0000">...</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<p><font color="#3333FF"># 5. Se acepta una conexion de un cliente y se
cambia de socket para atenderla</font>
<br><font color="#006600">$clientaddr</font> = accept(C,S) || die <font color="#FF0000">"accept:
</font><font color="#006600">$!</font><font color="#FF0000">"</font>;
<p><font color="#3333FF"># 6. Desempaquetamos la direccion del cliente
que llama</font>
<br>(<font color="#006600">$family</font>, <font color="#006600">$port</font>,
<font color="#006600">$ip</font>)
= unpack(<font color="#006600">$sockaddr</font>,<font color="#006600">$clientaddr</font>);
<br><font color="#006600">$ip</font> = gethostbyaddr(<font color="#006600">$ip</font>,AF_INET);
<br>print <font color="#FF0000">"Aceptada conexion del cliente </font><font color="#006600">$ip</font><font color="#FF0000">
por el puerto </font><font color="#006600">$port</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<p><font color="#3333FF"># 7. Recibimos la peticion y si no estamos muy
ocupados le mandamos la hora</font>
<br><font color="#006600">$pet </font>= &lt;C>;
<br>chop <font color="#006600">$pet</font>;
<br>print <font color="#FF0000">"Recibida del cliente la peticion: </font><font color="#006600">$pet</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<br>select C; <font color="#006600">$| </font>= <font color="#993399">1</font>;
select STDOUT;
<p><font color="#006600">$busy</font> = rand;
<br>if(<font color="#006600">$busy</font>&lt;<font color="#993399">0.5</font>)
<br>{
<br>&nbsp;&nbsp; <font color="#006600">$hora</font> = gmtime;
<br>&nbsp;&nbsp; print C <font color="#FF0000">"__TIME</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<br>&nbsp;&nbsp; print C <font color="#FF0000">"$hora</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<br>}
<br>else
<br>{
<br>&nbsp;&nbsp; print C <font color="#FF0000">"__BUSY</font><font color="#993399">\n</font><font color="#FF0000">"</font>;
<br>}
<p><font color="#3333FF"># Finalmente se cierra el socket</font>
<br>close(C) || die <font color="#FF0000">"close: </font><font color="#006600">$!</font><font color="#FF0000">"</font>;
<br>close(S) || die <font color="#FF0000">"close: </font><font color="#006600">$!</font><font color="#FF0000">"</font>;
<br>exit;</td>
</tr>
</table>

<br>&nbsp;
<p>Los mensajes __TIME y __BUSY asi como las respuestas son un ejemplo
de protocolo sencillo.
<div align=right>
<hr WIDTH="100%"></div>

<center><table BORDER=0 COLS=3 WIDTH="25%" NOSAVE >
<tr NOSAVE>
<td ALIGN=CENTER VALIGN=CENTER NOSAVE><a href="node3.html"><img SRC="ol.gif" BORDER=0 height=44 width=65></a></td>

<td ALIGN=CENTER VALIGN=CENTER NOSAVE><a href="index.html"><img SRC="home02.gif" BORDER=0 height=75 width=61></a></td>

<td ALIGN=CENTER VALIGN=CENTER NOSAVE><a href="node5.html"><img SRC="or.gif" BORDER=0 height=44 width=65></a></td>
</tr>

<tr NOSAVE>
<td ALIGN=CENTER VALIGN=CENTER NOSAVE><a href="node3.html">Anterior</a></td>

<td ALIGN=CENTER VALIGN=CENTER NOSAVE><a href="index.html">Home</a></td>

<td ALIGN=CENTER VALIGN=CENTER NOSAVE><a href="node5.html">Siguiente</a></td>
</tr>
</table></center>

<br>&nbsp;
<br>&nbsp;
<br>&nbsp;&nbsp;
</body>
</html>
